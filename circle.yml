## Customize the test machine
machine:
  php:
    version: 5.5.21
  node:
    version: 5.1.0

  hosts:
    ninja.dev: 127.0.0.1

general:
  artifacts:
    - "storage/"
    - "tests/_output/"

dependencies:
  pre:
    # set GitHub token and update composer
    - if [ -n "$GH_TOKEN" ]; then composer config github-oauth.github.com ${GH_TOKEN}; fi;
    - sudo composer self-update && composer -V

  override:
    # install Composer dependencies
    - composer install --prefer-dist --no-interaction --dev
    # install Node dependencies and build assets
    - npm install
    - bower install
    - grunt

  post:
    # copy configuration files
    - cp tests/_bootstrap.php.default tests/_bootstrap.php
    - cp tests/.env.circleci .env

  cache_directories:
    - "vendor"
    - "~/.composer/cache"

database:
  post:
    # create the database and user
    - mysql -u ubuntu -e "create database IF NOT EXISTS ninja;"
    - mysql -u ubuntu -e "GRANT ALL PRIVILEGES ON ninja.* To 'ninja'@'localhost' IDENTIFIED BY 'ninja'; FLUSH PRIVILEGES;"
    # migrate and seed the database
    - php artisan migrate --no-interaction
    - php artisan db:seed --no-interaction # default seed
    - php artisan db:seed --no-interaction --class=UserTableSeeder # development seed

test:
  pre:
    # Start webserver on ninja.dev:8000
    - php artisan serve --host=ninja.dev --port=8000:
          background: true
    # Start PhantomJS
    - phantomjs --webdriver=4444:
          background: true
    # Give it some time to start
    - sleep 5
    # Make sure the app is up-to-date
    - curl -L http://ninja.dev:8000/update

  override:
    - php ./vendor/codeception/codeception/codecept run --html --debug
